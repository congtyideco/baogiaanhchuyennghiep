<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o Gi√° Thu·ªëc - T·∫°o B·∫£ng ·∫¢nh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        .mode-selector, .ratio-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px auto 30px;
            max-width: 800px;
            flex-wrap: wrap;
        }
        .mode-btn, .ratio-btn {
            padding: 14px 28px;
            font-size: 16px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mode-btn:hover, .ratio-btn:hover {
            background: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .mode-btn.active, .ratio-btn.active {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .preview-grid {
            display: grid;
            gap: 15px;
            margin: 30px auto;
            max-width: 800px;
            padding: 20px;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .preview-grid-8 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .preview-grid-6 { grid-template-columns: 1fr 1fr 1fr; }
        .preview-grid-4 { grid-template-columns: 1fr 1fr; }
        .preview-grid-2 { grid-template-columns: 1fr 1fr; }
        .preview-grid-1 { grid-template-columns: 1fr; }
        /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî KHUNG ·∫¢NH ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
        .preview-item {
            width: 100%;
            /* aspect-ratio s·∫Ω ƒë∆∞·ª£c set b·ªüi JS d·ª±a tr√™n l·ª±a ch·ªçn */
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            border: 2px dashed #aaa;
            transition: all 0.2s;
        }
        .preview-item:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        .preview-item input {
            display: none;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
        }
        #exportPng, #exportPdf {
            background: #007bff;
            color: white;
        }
        #previewBtn {
            background: #28a745;
            color: white;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .actions {
            text-align: center;
            margin-top: 20px;
        }
        /* Modal Preview */
        #previewModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #previewContent {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }
        #closePreview {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #ff0000;
        }
        /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî B·∫¢NG XU·∫§T FILE (·∫®N) ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
        #hiddenExportBoard {
            position: fixed;
            left: -9999px;
            top: -9999px;
            width: 800px;
            background: white;
            padding: 30px;
            border: 4px solid red;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        #hiddenExportHeader {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }
        #hiddenExportHeader img {
            height: 60px;
        }
        #hiddenExportHeader .header-text {
            flex: 1;
        }
        #hiddenExportTitle {
            font-size: 26px;
            font-weight: bold;
            color: #d90000;
            margin: 0;
        }
        #hiddenExportSubtitle {
            font-size: 16px;
            font-style: italic;
            color: #555;
            margin: 10px 0 0 0;
        }
        #hiddenExportGrid {
            display: grid;
            gap: 15px;
        }
        #hiddenExportGrid.preview-grid-8 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        #hiddenExportGrid.preview-grid-6 { grid-template-columns: 1fr 1fr 1fr; }
        #hiddenExportGrid.preview-grid-4 { grid-template-columns: 1fr 1fr; }
        #hiddenExportGrid.preview-grid-2 { grid-template-columns: 1fr 1fr; }
        #hiddenExportGrid.preview-grid-1 { grid-template-columns: 1fr; }
        .hidden-export-item {
            width: 100%;
            /* aspect-ratio s·∫Ω ƒë∆∞·ª£c set b·ªüi JS d·ª±a tr√™n l·ª±a ch·ªçn */
            background: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
        }
        .hidden-export-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }
        #hiddenExportFooter {
            text-align: center;
            margin-top: 30px;
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        #hiddenExportAddress {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #555;
            line-height: 1.5;
        }
        .preview-grid {
            display: none;
        }
        .preview-grid.active {
            display: grid;
        }
    </style>
</head>
<body>
    <h1>üì∏ T·∫°o B·∫£ng B√°o Gi√° </h1>
    
    <div class="mode-selector">
        <button class="mode-btn active" data-mode="8">B√°o Gi√° 8 ·∫¢nh</button>
        <button class="mode-btn" data-mode="6">B√°o Gi√° 6 ·∫¢nh</button>
        <button class="mode-btn" data-mode="4">B√°o Gi√° 4 ·∫¢nh</button>
        <button class="mode-btn" data-mode="2">B√°o Gi√° 2 ·∫¢nh</button>
        <button class="mode-btn" data-mode="1">B√°o Gi√° 1 ·∫¢nh</button>
    </div>

    <!-- ‚úÖ TH√äM B·ªò CH·ªåN T·ª∂ L·ªÜ KHUNG H√åNH -->
    <div class="ratio-selector">
        <button class="ratio-btn active" data-ratio="3/4">T·ª∑ l·ªá 3:4</button>
        <button class="ratio-btn" data-ratio="1/1">T·ª∑ l·ªá 1:1</button>
    </div>

    <!-- ‚úÖ TH√äM KHUNG 8 ·∫¢NH -->
    <div class="preview-grid preview-grid-8 active" id="grid8">
        <div class="preview-item" id="item8-1">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 1</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item8-2">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 2</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item8-3">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 3</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item8-4">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 4</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item8-5">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 5</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item8-6">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 6</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item8-7">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 7</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item8-8">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 8</span>
            <input type="file" accept="image/*">
        </div>
    </div>

    <!-- ‚úÖ KHUNG 6 ·∫¢NH -->
    <div class="preview-grid preview-grid-6" id="grid6">
        <div class="preview-item" id="item6-1">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 1</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item6-2">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 2</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item6-3">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 3</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item6-4">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 4</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item6-5">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 5</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item6-6">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 6</span>
            <input type="file" accept="image/*">
        </div>
    </div>

    <div class="preview-grid preview-grid-4" id="grid4">
        <div class="preview-item" id="item4-1">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 1</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item4-2">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 2</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item4-3">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 3</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item4-4">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 4</span>
            <input type="file" accept="image/*">
        </div>
    </div>
    <div class="preview-grid preview-grid-2" id="grid2">
        <div class="preview-item" id="item2-1">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 1</span>
            <input type="file" accept="image/*">
        </div>
        <div class="preview-item" id="item2-2">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh 2</span>
            <input type="file" accept="image/*">
        </div>
    </div>
    <div class="preview-grid preview-grid-1" id="grid1">
        <div class="preview-item" id="item1-1">
            <span>Click ho·∫∑c k√©o th·∫£ ·∫£nh</span>
            <input type="file" accept="image/*">
        </div>
    </div>
    <div class="actions">
        <button id="previewBtn" disabled>Xem tr∆∞·ªõc</button>
        <button id="exportPng" disabled>Xu·∫•t PNG</button>
        <button id="exportPdf" disabled>Xu·∫•t PDF</button>
    </div>
    <!-- Modal Xem tr∆∞·ªõc -->
    <div id="previewModal">
        <div id="previewContent">
            <span id="closePreview">&times;</span>
            <div id="modalExportBoard">
                <!-- S·∫Ω ƒë∆∞·ª£c clone t·ª´ hiddenExportBoard -->
            </div>
        </div>
    </div>
    <!-- üö´ B·∫¢NG XU·∫§T FILE ·∫®N ‚Äî CH·ªà D√ôNG ƒê·ªÇ CH·ª§P ·∫¢NH ‚Äî KH√îNG HI·ªÇN TH·ªä TR√äN M√ÄN H√åNH -->
    <div id="hiddenExportBoard">
        <div id="hiddenExportHeader">
            <img id="companyLogo" src="" alt="Logo C√¥ng Ty">
            <div class="header-text">
                <div id="hiddenExportTitle">B√ÅO GI√Å CHO ƒê·∫†I L√ù </div>
                <div id="hiddenExportSubtitle">K√≠nh g·ªüi: Qu√Ω Kh√°ch h√†ng - ƒê·∫°i l√Ω</div>
            </div>
        </div>
        <div id="hiddenExportGrid" class="preview-grid-8">
            <!-- S·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
        </div>
        <div id="hiddenExportFooter">C√îNG TY IDECO TR√ÇN TR·ªåNG</div>
        <div id="hiddenExportAddress">003 Carlion 5 - 262/3 L≈©y B√°n B√≠ch - P. T√¢n Ph√∫ - Tp. HCM - Hotline: 0385400436</div>
    </div>
    <script>
        const grids = {
            '8': document.getElementById('grid8'),
            '6': document.getElementById('grid6'),
            '4': document.getElementById('grid4'),
            '2': document.getElementById('grid2'),
            '1': document.getElementById('grid1')
        };
        const items = {
            '8': [
                document.getElementById('item8-1'),
                document.getElementById('item8-2'),
                document.getElementById('item8-3'),
                document.getElementById('item8-4'),
                document.getElementById('item8-5'),
                document.getElementById('item8-6'),
                document.getElementById('item8-7'),
                document.getElementById('item8-8')
            ],
            '6': [
                document.getElementById('item6-1'),
                document.getElementById('item6-2'),
                document.getElementById('item6-3'),
                document.getElementById('item6-4'),
                document.getElementById('item6-5'),
                document.getElementById('item6-6')
            ],
            '4': [
                document.getElementById('item4-1'),
                document.getElementById('item4-2'),
                document.getElementById('item4-3'),
                document.getElementById('item4-4')
            ],
            '2': [
                document.getElementById('item2-1'),
                document.getElementById('item2-2')
            ],
            '1': [
                document.getElementById('item1-1')
            ]
        };
        const previewModal = document.getElementById('previewModal');
        const previewBtn = document.getElementById('previewBtn');
        const exportPngBtn = document.getElementById('exportPng');
        const exportPdfBtn = document.getElementById('exportPdf');
        const closePreview = document.getElementById('closePreview');
        const companyLogo = document.getElementById('companyLogo');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const ratioButtons = document.querySelectorAll('.ratio-btn');
        const hiddenExportBoard = document.getElementById('hiddenExportBoard');
        const hiddenExportGrid = document.getElementById('hiddenExportGrid');
        const modalExportBoard = document.getElementById('modalExportBoard');
        let currentMode = '8'; // M·∫∑c ƒë·ªãnh l√† 8 ·∫£nh
        let currentRatio = '3/4';
        let imageSources = {
            '8': [null, null, null, null, null, null, null, null],
            '6': [null, null, null, null, null, null],
            '4': [null, null, null, null],
            '2': [null, null],
            '1': [null]
        };

        // ‚úÖ H√†m c·∫≠p nh·∫≠t t·ª∑ l·ªá khung h√¨nh cho t·∫•t c·∫£ c√°c √¥
        function updateAllAspectRatios(ratio) {
            document.querySelectorAll('.preview-item').forEach(item => {
                item.style.aspectRatio = ratio;
            });
            document.querySelectorAll('.hidden-export-item').forEach(item => {
                item.style.aspectRatio = ratio;
            });
        }

        // T·∫£i logo
        let logoBase64 = null;
        function loadLogo() {
            const logoUrl = "https://cdn.imgpile.com/f/5cLRy50_xl.jpg";
            fetch(logoUrl)
                .then(response => response.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        logoBase64 = reader.result;
                        companyLogo.src = logoBase64;
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(err => {
                    console.warn("Kh√¥ng t·∫£i ƒë∆∞·ª£c logo, d√πng placeholder.", err);
                    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="60" viewBox="0 0 200 60">
                        <rect width="200" height="60" fill="#eee"/>
                        <text x="10" y="35" font-family="Arial" font-size="14" fill="#999">[LOGO]</text>
                    </svg>`;
                    const b64 = btoa(unescape(encodeURIComponent(svg)));
                    logoBase64 = `image/svg+xml;base64,${b64}`;
                    companyLogo.src = logoBase64;
                });
        }
        loadLogo();

        // G√°n s·ª± ki·ªán
        function setupItemEvents(item, input, index, mode) {
            item.addEventListener('click', (e) => {
                if (e.target !== input) input.click();
            });
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                item.addEventListener(event, e => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            ['dragenter', 'dragover'].forEach(event => {
                item.addEventListener(event, () => {
                    item.style.borderColor = '#007bff';
                    item.style.backgroundColor = '#e7f3ff';
                });
            });
            ['dragleave', 'drop'].forEach(event => {
                item.addEventListener(event, () => {
                    item.style.borderColor = '#aaa';
                    item.style.backgroundColor = '#f9f9f9';
                });
            });
            item.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length && files[0].type.startsWith('image/')) {
                    handleImage(files[0], item, index, mode);
                }
            });
            input.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleImage(e.target.files[0], item, index, mode);
                }
            });
        }

        function handleImage(file, container, index, mode) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                container.innerHTML = '';
                container.appendChild(img);
                imageSources[mode][index] = e.target.result;
                if (mode === currentMode) {
                    checkEnableExport();
                }
            };
            reader.readAsDataURL(file);
        }

        for (let mode in items) {
            items[mode].forEach((item, index) => {
                const input = item.querySelector('input');
                setupItemEvents(item, input, index, mode);
            });
        }

        function checkEnableExport() {
            const count = imageSources[currentMode].filter(src => src !== null).length;
            const hasAnyImage = count > 0;
            previewBtn.disabled = !hasAnyImage;
            exportPngBtn.disabled = !hasAnyImage;
            exportPdfBtn.disabled = !hasAnyImage;
        }

        function switchMode(mode) {
            for (let key in grids) grids[key].classList.remove('active');
            grids[mode].classList.add('active');
            currentMode = mode;
            modeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mode === mode));
            checkEnableExport();
        }

        function switchRatio(ratio) {
            currentRatio = ratio;
            ratioButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.ratio === ratio));
            updateAllAspectRatios(ratio);
        }

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => switchMode(btn.dataset.mode));
        });

        ratioButtons.forEach(btn => {
            btn.addEventListener('click', () => switchRatio(btn.dataset.ratio));
        });

        // ‚úÖ H√ÄM T·∫†O N·ªòI DUNG XU·∫§T
        function prepareExportBoard() {
            if (logoBase64) {
                companyLogo.src = logoBase64;
            }
            hiddenExportGrid.className = `preview-grid preview-grid-${currentMode}`;
            hiddenExportGrid.innerHTML = '';
            
            const currentSources = imageSources[currentMode];
            for (let i = 0; i < currentSources.length; i++) {
                const item = document.createElement('div');
                item.className = 'hidden-export-item';
                item.style.aspectRatio = currentRatio;
                if (currentSources[i]) {
                    const img = document.createElement('img');
                    img.src = currentSources[i];
                    item.appendChild(img);
                } else {
                    const span = document.createElement('span');
                    span.textContent = "‚Äî";
                    span.style.color = "#ccc";
                    span.style.fontSize = "16px";
                    span.style.fontWeight = "bold";
                    item.appendChild(span);
                }
                hiddenExportGrid.appendChild(item);
            }
        }

        // ‚úÖ XEM TR∆Ø·ªöC
        previewBtn.addEventListener('click', () => {
            prepareExportBoard();
            modalExportBoard.innerHTML = '';
            const clone = hiddenExportBoard.cloneNode(true);
            clone.id = '';
            modalExportBoard.appendChild(clone);
            previewModal.style.display = 'flex';
        });

        closePreview.addEventListener('click', () => previewModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === previewModal) previewModal.style.display = 'none';
        });

        // ‚úÖ XU·∫§T PNG
        exportPngBtn.addEventListener('click', () => {
            prepareExportBoard();
            html2canvas(hiddenExportBoard, {
                scale: 2,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `bao-gia-thuoc-${currentMode}-anh.png`;
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }).catch(err => {
                alert("L·ªói khi t·∫°o PNG: " + err.message);
                console.error(err);
            });
        });

        // ‚úÖ XU·∫§T PDF
        exportPdfBtn.addEventListener('click', () => {
            prepareExportBoard();
            html2canvas(hiddenExportBoard, {
                scale: 2,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = 210;
                const pdfHeight = 297;
                const imgWidth = pdfWidth - 20;
                const ratio = canvas.width / canvas.height;
                const imgHeight = imgWidth / ratio;
                const x = 10;
                const y = Math.max(10, (pdfHeight - imgHeight) / 2);
                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x, y, imgWidth, imgHeight);
                pdf.save(`bao-gia-thuoc-${currentMode}-anh.pdf`);
            }).catch(err => {
                alert("L·ªói khi t·∫°o PDF: " + err.message);
                console.error(err);
            });
        });

        // ‚úÖ Khi trang v·ª´a load, ƒë·∫£m b·∫£o set t·ª∑ l·ªá ban ƒë·∫ßu cho t·∫•t c·∫£ c√°c √¥
        updateAllAspectRatios(currentRatio);
    </script>
</body>
</html>
