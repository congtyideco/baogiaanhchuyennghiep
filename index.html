<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o Gi√° Thu·ªëc - T·ª± ƒê·ªông Theo Kh·ªï ·∫¢nh</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f0f2f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        p.sub-title {
            text-align: center;
            color: #666;
            margin-bottom: 25px;
            font-size: 14px;
        }
        
        /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CONTROLS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            max-width: 900px;
            margin: 0 auto 30px;
        }
        
        .control-group {
            margin-bottom: 15px;
            text-align: center;
        }
        .control-label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
        }

        .mode-selector, .ratio-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mode-btn, .ratio-btn {
            padding: 10px 20px;
            font-size: 14px;
            border: 1px solid #d1d9e6;
            background: #f8f9fa;
            color: #495057;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        
        .mode-btn:hover, .ratio-btn:hover {
            background: #e2e6ea;
            transform: translateY(-1px);
        }

        .mode-btn.active, .ratio-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 4px 6px rgba(0,123,255,0.2);
        }

        /* N√∫t ƒë·∫∑c bi·ªát cho t√≠nh nƒÉng m·ªõi */
        .ratio-btn[data-ratio="auto"] {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeeba;
        }
        .ratio-btn[data-ratio="auto"].active {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
        }

        /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî GRID DISPLAY ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
        .preview-grid {
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
            gap: 15px;
            margin: 0 auto;
            max-width: 900px;
            padding: 20px;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            border-radius: 12px;
        }
        .preview-grid.active { display: grid; }

        .preview-grid-8 { grid-template-columns: repeat(4, 1fr); }
        .preview-grid-6 { grid-template-columns: repeat(3, 1fr); }
        .preview-grid-4 { grid-template-columns: repeat(2, 1fr); }
        .preview-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .preview-grid-1 { grid-template-columns: 1fr; }

        .preview-item {
            width: 100%;
            /* aspect-ratio set by JS */
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            border: 2px dashed #cbd5e0;
            transition: all 0.2s;
            flex-direction: column;
            text-align: center;
        }
        .preview-item:hover {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: fill; /* Thay ƒë·ªïi t·ª´ cover sang fill ƒë·ªÉ l·∫•p ƒë·∫ßy ƒë√∫ng kh·ªï */
            display: block;
        }
        .preview-item span {
            padding: 10px;
            font-size: 13px;
            color: #adb5bd;
            pointer-events: none;
        }
        .preview-item input { display: none; }

        /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî BUTTONS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
        .actions {
            text-align: center;
            margin-top: 30px;
            padding-bottom: 50px;
        }
        .action-btn {
            padding: 12px 25px;
            margin: 0 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            color: white;
            transition: transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .action-btn:hover { transform: translateY(-2px); }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        #previewBtn { background: linear-gradient(45deg, #28a745, #218838); }
        #exportPng { background: linear-gradient(45deg, #007bff, #0056b3); }
        #exportPdf { background: linear-gradient(45deg, #dc3545, #c82333); }

        /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî MODAL ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
        #previewModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        #previewContent {
            background: white;
            padding: 10px;
            border-radius: 8px;
            max-width: 95%;
            max-height: 95%;
            overflow: auto;
            position: relative;
        }
        #closePreview {
            position: absolute;
            top: 10px; right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #d9534f;
            z-index: 2001;
            font-weight: bold;
        }

        /* ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî HIDDEN EXPORT BOARD ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî */
        #hiddenExportBoard {
            position: fixed;
            left: -9999px; top: -9999px;
            width: 1200px; /* ƒê·ªô ph√¢n gi·∫£i cao h∆°n */
            background: white;
            padding: 40px;
            border-radius: 0;
        }
        #hiddenExportHeader {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            border-bottom: 3px solid #d90000;
            padding-bottom: 20px;
        }
        #companyLogo { height: 80px; object-fit: contain; }
        #hiddenExportHeader .header-text { flex: 1; }
        #hiddenExportTitle {
            font-size: 36px;
            font-weight: 800;
            color: #d90000;
            margin: 0;
            text-transform: uppercase;
            line-height: 1.2;
        }
        #hiddenExportSubtitle {
            font-size: 20px;
            font-weight: 500;
            color: #333;
            margin-top: 5px;
        }
        
        /* Grid trong ph·∫ßn xu·∫•t file */
        #hiddenExportGrid { display: grid; gap: 20px; }
        #hiddenExportGrid.preview-grid-8 { grid-template-columns: repeat(4, 1fr); }
        #hiddenExportGrid.preview-grid-6 { grid-template-columns: repeat(3, 1fr); }
        #hiddenExportGrid.preview-grid-4 { grid-template-columns: repeat(2, 1fr); }
        #hiddenExportGrid.preview-grid-2 { grid-template-columns: repeat(2, 1fr); }
        #hiddenExportGrid.preview-grid-1 { grid-template-columns: 1fr; }

        .hidden-export-item {
            width: 100%;
            /* aspect-ratio set by JS */
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        .hidden-export-item img {
            width: 100%;
            height: 100%;
            object-fit: fill; /* L·∫•p ƒë·∫ßy ƒë·ªÉ kh√¥ng b·ªã kho·∫£ng tr·∫Øng */
        }
        .empty-slot {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #fcfcfc; color: #eee;
            font-weight: bold; font-size: 40px;
        }

        #hiddenExportFooter {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        #hiddenFooterCompany { font-weight: bold; font-size: 24px; color: #333; margin-bottom: 8px; }
        #hiddenExportAddress { font-size: 16px; color: #555; }
    </style>
</head>
<body>

    <h1>üì∏ T·∫°o B·∫£ng ·∫¢nh B√°o Gi√°</h1>
    <p class="sub-title">C√¥ng c·ª• t·∫°o ·∫£nh b√°o gi√° thu·ªëc chuy√™n nghi·ªáp cho Tr√¨nh D∆∞·ª£c Vi√™n</p>
    
    <div class="control-panel">
        <div class="control-group">
            <span class="control-label">1. Ch·ªçn s·ªë l∆∞·ª£ng ·∫£nh</span>
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="8">8 ·∫¢nh</button>
                <button class="mode-btn" data-mode="6">6 ·∫¢nh</button>
                <button class="mode-btn" data-mode="4">4 ·∫¢nh</button>
                <button class="mode-btn" data-mode="2">2 ·∫¢nh</button>
                <button class="mode-btn" data-mode="1">1 ·∫¢nh</button>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">2. Ch·ªçn t·ª∑ l·ªá khung h√¨nh</span>
            <div class="ratio-selector">
                <button class="ratio-btn active" data-ratio="3/4">3:4 (D·ªçc)</button>
                <button class="ratio-btn" data-ratio="1/1">1:1 (Vu√¥ng)</button>
                <button class="ratio-btn" data-ratio="4/3">4:3 (Ngang)</button>
                <button class="ratio-btn" data-ratio="auto" id="btnAutoRatio">‚ö° Theo kh·ªï ·∫£nh g·ªëc</button>
            </div>
        </div>
    </div>

    <div class="preview-grid preview-grid-8 active" id="grid8">
        </div>
    <div class="preview-grid preview-grid-6" id="grid6"></div>
    <div class="preview-grid preview-grid-4" id="grid4"></div>
    <div class="preview-grid preview-grid-2" id="grid2"></div>
    <div class="preview-grid preview-grid-1" id="grid1"></div>

    <div class="actions">
        <button id="previewBtn" class="action-btn" disabled>Xem tr∆∞·ªõc</button>
        <button id="exportPng" class="action-btn" disabled>T·∫£i ·∫£nh (PNG)</button>
        <button id="exportPdf" class="action-btn" disabled>T·∫£i PDF</button>
    </div>

    <div id="previewModal">
        <div id="previewContent">
            <span id="closePreview">&times;</span>
            <div id="modalExportBoard" style="transform: scale(0.8); transform-origin: top center;">
                </div>
        </div>
    </div>

    <div id="hiddenExportBoard">
        <div id="hiddenExportHeader">
            <img id="companyLogo" src="" alt="Logo">
            <div class="header-text">
                <div id="hiddenExportTitle">B·∫¢NG B√ÅO GI√Å S·∫¢N PH·∫®M</div>
                <div id="hiddenExportSubtitle">K√≠nh g·ª≠i: Qu√Ω Kh√°ch h√†ng - ƒê·ªëi t√°c</div>
            </div>
        </div>
        <div id="hiddenExportGrid" class="preview-grid-8">
            </div>
        <div id="hiddenExportFooter">
            <div id="hiddenFooterCompany">C√îNG TY IDECO TR√ÇN TR·ªåNG</div>
            <div id="hiddenExportAddress">VƒÉn ph√≤ng: 003 Carlion 5 - 262/3 L≈©y B√°n B√≠ch - P. T√¢n Ph√∫ - Tp. HCM<br>Hotline: 0385400436</div>
        </div>
    </div>

    <script>
        // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî C·∫§U H√åNH & KH·ªûI T·∫†O ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        const grids = {
            '8': document.getElementById('grid8'),
            '6': document.getElementById('grid6'),
            '4': document.getElementById('grid4'),
            '2': document.getElementById('grid2'),
            '1': document.getElementById('grid1')
        };
        
        // Kh·ªüi t·∫°o c√°c √¥ input cho t·ª´ng l∆∞·ªõi (ƒë·ªÉ code HTML g·ªçn h∆°n)
        function initGridHTML() {
            for (let [mode, gridElement] of Object.entries(grids)) {
                let html = '';
                for (let i = 1; i <= parseInt(mode); i++) {
                    html += `
                        <div class="preview-item" id="item${mode}-${i}" data-index="${i-1}" data-mode="${mode}">
                            <span>·∫¢nh ${i}<br><small>(K√©o th·∫£ ho·∫∑c Click)</small></span>
                            <input type="file" accept="image/*">
                        </div>
                    `;
                }
                gridElement.innerHTML = html;
            }
        }
        initGridHTML();

        // Bi·∫øn to√†n c·ª•c
        let currentMode = '8';
        let currentRatio = '3/4'; // Gi√° tr·ªã m·∫∑c ƒë·ªãnh
        let detectedRatio = null; // L∆∞u t·ª∑ l·ªá ph√°t hi·ªán ƒë∆∞·ª£c t·ª´ ·∫£nh t·∫£i l√™n
        
        const imageSources = {
            '8': Array(8).fill(null),
            '6': Array(6).fill(null),
            '4': Array(4).fill(null),
            '2': Array(2).fill(null),
            '1': Array(1).fill(null)
        };

        const previewBtn = document.getElementById('previewBtn');
        const exportPngBtn = document.getElementById('exportPng');
        const exportPdfBtn = document.getElementById('exportPdf');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const ratioButtons = document.querySelectorAll('.ratio-btn');
        const companyLogo = document.getElementById('companyLogo');

        // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî LOGO LOADER ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        function loadLogo() {
            // Logo placeholder n·∫øu link l·ªói
            const logoUrl = "https://cdn.imgpile.com/f/5cLRy50_xl.jpg";
            fetch(logoUrl)
                .then(r => r.blob())
                .then(blob => {
                    const reader = new FileReader();
                    reader.onload = () => companyLogo.src = reader.result;
                    reader.readAsDataURL(blob);
                })
                .catch(() => {
                    // SVG fallback
                    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="80" viewBox="0 0 200 80"><rect width="200" height="80" fill="#eee"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" fill="#999">LOGO IDECO</text></svg>`;
                    companyLogo.src = `data:image/svg+xml;base64,${btoa(svg)}`;
                });
        }
        loadLogo();

        // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî X·ª¨ L√ù S·ª∞ KI·ªÜN ·∫¢NH ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        document.querySelectorAll('.preview-item').forEach(item => {
            const input = item.querySelector('input');
            const mode = item.dataset.mode;
            const index = parseInt(item.dataset.index);

            // Click ƒë·ªÉ upload
            item.addEventListener('click', (e) => {
                if(e.target !== input) input.click();
            });

            // Drag & Drop
            ['dragenter', 'dragover'].forEach(evt => {
                item.addEventListener(evt, (e) => {
                    e.preventDefault();
                    item.style.borderColor = '#007bff';
                    item.style.backgroundColor = '#e7f3ff';
                });
            });
            ['dragleave', 'drop'].forEach(evt => {
                item.addEventListener(evt, (e) => {
                    e.preventDefault();
                    item.style.borderColor = '#cbd5e0';
                    item.style.backgroundColor = '#f8f9fa';
                });
            });

            item.addEventListener('drop', (e) => {
                if(e.dataTransfer.files.length) {
                    processFile(e.dataTransfer.files[0], item, mode, index);
                }
            });

            input.addEventListener('change', (e) => {
                if(e.target.files.length) {
                    processFile(e.target.files[0], item, mode, index);
                }
            });
        });

        function processFile(file, container, mode, index) {
            if (!file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const result = e.target.result;
                
                // Hi·ªÉn th·ªã ·∫£nh
                const img = document.createElement('img');
                img.src = result;
                container.innerHTML = ''; 
                container.appendChild(img);
                
                // L∆∞u d·ªØ li·ªáu
                imageSources[mode][index] = result;

                // LOGIC QUAN TR·ªåNG: T·ª± ƒë·ªông ph√°t hi·ªán t·ª∑ l·ªá n·∫øu ƒëang ch·ªçn ch·∫ø ƒë·ªô "Auto"
                // Ho·∫∑c n·∫øu ƒë√¢y l√† ·∫£nh ƒë·∫ßu ti√™n ƒë∆∞·ª£c upload v√† ch∆∞a c√≥ t·ª∑ l·ªá detected
                if (currentRatio === 'auto') {
                    detectAndApplyRatio(result);
                }

                if (mode === currentMode) checkEnableExport();
            };
            reader.readAsDataURL(file);
        }

        // H√†m ph√°t hi·ªán t·ª∑ l·ªá t·ª´ ·∫£nh
        function detectAndApplyRatio(imgSrc) {
            const imageObj = new Image();
            imageObj.onload = function() {
                const w = this.naturalWidth;
                const h = this.naturalHeight;
                // T√≠nh t·ª∑ l·ªá d·∫°ng chu·ªói CSS (VD: "500 / 800")
                detectedRatio = `${w} / ${h}`;
                
                // √Åp d·ª•ng ngay l·∫≠p t·ª©c
                applyRatioToAll(detectedRatio);
                console.log(`ƒê√£ ph√°t hi·ªán kh·ªï ·∫£nh: ${w}x${h}. √Åp d·ª•ng t·ª∑ l·ªá: ${detectedRatio}`);
            };
            imageObj.src = imgSrc;
        }

        function applyRatioToAll(ratio) {
            // √Åp d·ª•ng cho c√°c √¥ xem tr∆∞·ªõc
            document.querySelectorAll('.preview-item').forEach(el => {
                el.style.aspectRatio = ratio;
            });
            // √Åp d·ª•ng cho b·∫£ng xu·∫•t ·∫©n
            document.querySelectorAll('.hidden-export-item').forEach(el => {
                el.style.aspectRatio = ratio;
            });
        }

        // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CHUY·ªÇN ƒê·ªîI CH·∫æ ƒê·ªò ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        
        // 1. Chuy·ªÉn s·ªë l∆∞·ª£ng ·∫£nh (1, 2, 4, 6, 8)
        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;
                // UI update
                modeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Grid update
                Object.values(grids).forEach(g => g.classList.remove('active'));
                grids[mode].classList.add('active');
                
                currentMode = mode;
                checkEnableExport();
            });
        });

        // 2. Chuy·ªÉn t·ª∑ l·ªá (3:4, 1:1, Auto)
        ratioButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const ratio = btn.dataset.ratio;
                
                // UI update
                ratioButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                currentRatio = ratio;

                if (ratio === 'auto') {
                    // N·∫øu ch·ªçn auto, ki·ªÉm tra xem ƒë√£ c√≥ ·∫£nh n√†o trong grid hi·ªán t·∫°i ch∆∞a
                    // T√¨m ·∫£nh ƒë·∫ßu ti√™n kh√¥ng null
                    const firstImgSrc = imageSources[currentMode].find(src => src !== null);
                    if (firstImgSrc) {
                        detectAndApplyRatio(firstImgSrc);
                    } else {
                        // N·∫øu ch∆∞a c√≥ ·∫£nh, gi·ªØ t·ª∑ l·ªá c≈© ho·∫∑c th√¥ng b√°o nh·∫π (kh√¥ng l√†m g√¨ ch·ªù upload)
                        // alert('Vui l√≤ng t·∫£i ·∫£nh l√™n ƒë·ªÉ t·ª± ƒë·ªông l·∫•y t·ª∑ l·ªá.');
                    }
                } else {
                    // N·∫øu ch·ªçn t·ª∑ l·ªá c·ªë ƒë·ªãnh
                    applyRatioToAll(ratio);
                }
            });
        });

        function checkEnableExport() {
            // Ch·ªâ c·∫ßn c√≥ √≠t nh·∫•t 1 ·∫£nh l√† cho xu·∫•t
            const hasImage = imageSources[currentMode].some(src => src !== null);
            previewBtn.disabled = !hasImage;
            exportPngBtn.disabled = !hasImage;
            exportPdfBtn.disabled = !hasImage;
        }

        // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî LOGIC XU·∫§T FILE ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
        function prepareExportBoard() {
            const exportGrid = document.getElementById('hiddenExportGrid');
            const data = imageSources[currentMode];
            
            // Set class l∆∞·ªõi t∆∞∆°ng ·ª©ng
            exportGrid.className = `preview-grid-${currentMode}`; // Reset class
            exportGrid.innerHTML = ''; // X√≥a c≈©

            // X√°c ƒë·ªãnh t·ª∑ l·ªá c·∫ßn d√πng cho l√∫c xu·∫•t
            let finalRatio = currentRatio;
            if (currentRatio === 'auto' && detectedRatio) {
                finalRatio = detectedRatio;
            } else if (currentRatio === 'auto' && !detectedRatio) {
                finalRatio = '3/4'; // Fallback n·∫øu ch·ªçn auto m√† ch∆∞a c√≥ ·∫£nh
            }

            data.forEach(src => {
                const div = document.createElement('div');
                div.className = 'hidden-export-item';
                div.style.aspectRatio = finalRatio;
                
                if (src) {
                    const img = document.createElement('img');
                    img.src = src;
                    div.appendChild(img);
                } else {
                    const empty = document.createElement('div');
                    empty.className = 'empty-slot';
                    empty.innerHTML = '&mdash;';
                    div.appendChild(empty);
                }
                exportGrid.appendChild(div);
            });
        }

        // 1. Xem tr∆∞·ªõc
        const modal = document.getElementById('previewModal');
        const modalContent = document.getElementById('modalExportBoard');
        
        previewBtn.addEventListener('click', () => {
            prepareExportBoard();
            // Clone t·ª´ hidden board sang modal
            modalContent.innerHTML = '';
            const clone = document.getElementById('hiddenExportBoard').cloneNode(true);
            clone.id = 'temp-preview';
            clone.style.position = 'static';
            clone.style.width = '100%';
            clone.style.left = 'auto';
            clone.style.top = 'auto';
            modalContent.appendChild(clone);
            modal.style.display = 'flex';
        });

        document.getElementById('closePreview').addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', (e) => {
            if(e.target === modal) modal.style.display = 'none';
        });

        // 2. Xu·∫•t PNG
        exportPngBtn.addEventListener('click', () => {
            prepareExportBoard();
            const element = document.getElementById('hiddenExportBoard');
            
            // T·∫°m th·ªùi hi·ªÉn th·ªã ƒë·ªÉ ch·ª•p (n·∫øu c·∫ßn), html2canvas c√≥ th·ªÉ ch·ª•p hidden nh∆∞ng ƒë√¥i khi l·ªói font
            // C√°ch t·ªët nh·∫•t: d√πng window.scrollTo ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã l·ªói viewport
            window.scrollTo(0,0);

            html2canvas(element, {
                scale: 2, // TƒÉng ch·∫•t l∆∞·ª£ng
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `BaoGia_IDECO_${new Date().getTime()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => alert("L·ªói xu·∫•t ·∫£nh: " + err));
        });

        // 3. Xu·∫•t PDF
        exportPdfBtn.addEventListener('click', () => {
            prepareExportBoard();
            const element = document.getElementById('hiddenExportBoard');
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                // N·∫øu ·∫£nh d√†i qu√° A4 th√¨ ng·∫Øt trang (c∆° b·∫£n ·ªü ƒë√¢y fit 1 trang tr∆∞·ªõc)
                // ·ªû ƒë√¢y ta scale fit width
                const topMargin = 10;
                
                if (pdfHeight > 290) {
                     // N·∫øu qu√° d√†i, t·ª± ƒë·ªông scale nh·ªè l·∫°i v·ª´a trang A4 (fit page)
                     const scaleFactor = 280 / pdfHeight;
                     const newWidth = pdfWidth * scaleFactor;
                     const newHeight = pdfHeight * scaleFactor;
                     const marginX = (pdfWidth - newWidth) / 2;
                     pdf.addImage(imgData, 'PNG', marginX, topMargin, newWidth, newHeight);
                } else {
                    pdf.addImage(imgData, 'PNG', 0, topMargin, pdfWidth, pdfHeight);
                }

                pdf.save(`BaoGia_IDECO_${new Date().getTime()}.pdf`);
            });
        });

        // Set t·ª∑ l·ªá m·∫∑c ƒë·ªãnh ban ƒë·∫ßu
        applyRatioToAll(currentRatio);

    </script>
</body>
</html>
